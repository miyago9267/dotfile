# =====================================
# Mars.nvim 風格的 tmux 配置整合
# =====================================

# ---------------------------------
# 基本設定
# ---------------------------------
# 啟用 256 色彩
set -g default-terminal "screen-256color"
set -ga terminal-overrides ",xterm-256color:Tc"

# 滑鼠支援
set -g mouse on

# 視窗和窗格編號從 1 開始（更直覺）
set -g base-index 1
setw -g pane-base-index 1

# 自動重新編號視窗
set -g renumber-windows on

# 加快指令序列速度
set -s escape-time 0

# 歷史記錄行數
set -g history-limit 50000

# ---------------------------------
# vim-tmux-navigator 整合
# ---------------------------------
# 這讓你可以在 Neovim 和 tmux 窗格間用相同的快捷鍵切換
# 需要在 Neovim 中安裝 christoomey/vim-tmux-navigator

# 判斷是否在 Vim/Neovim 中
is_vim="ps -o state= -o comm= -t '#{pane_tty}' \
    | grep -iqE '^[^TXZ ]+ +(\\S+\\/)?g?(view|n?vim?x?)(diff)?$'"

# 使用 C-h/j/k/l 在窗格間切換（與 Vim 相同）
bind-key -n 'C-h' if-shell "$is_vim" 'send-keys C-h'  'select-pane -L'
bind-key -n 'C-j' if-shell "$is_vim" 'send-keys C-j'  'select-pane -D'
bind-key -n 'C-k' if-shell "$is_vim" 'send-keys C-k'  'select-pane -U'
bind-key -n 'C-l' if-shell "$is_vim" 'send-keys C-l'  'select-pane -R'

# tmux 3.x 版本的語法
tmux_version='$(tmux -V | sed -En "s/^tmux ([0-9]+(.[0-9]+)?).*/\1/p")'
if-shell -b '[ "$(echo "$tmux_version < 3.0" | bc)" = 1 ]' \
    "bind-key -n 'C-\\' if-shell \"$is_vim\" 'send-keys C-\\'  'select-pane -l'"
if-shell -b '[ "$(echo "$tmux_version >= 3.0" | bc)" = 1 ]' \
    "bind-key -n 'C-\\' if-shell \"$is_vim\" 'send-keys C-\\\\'  'select-pane -l'"

# 在 copy-mode-vi 模式下也能使用
bind-key -T copy-mode-vi 'C-h' select-pane -L
bind-key -T copy-mode-vi 'C-j' select-pane -D
bind-key -T copy-mode-vi 'C-k' select-pane -U
bind-key -T copy-mode-vi 'C-l' select-pane -R
bind-key -T copy-mode-vi 'C-\' select-pane -l

# ---------------------------------
# 分割窗格快捷鍵（Mars.nvim 風格）
# ---------------------------------
# | 垂直分割（左右分割）
bind | split-window -h -c "#{pane_current_path}"
# _ 水平分割（上下分割）
bind _ split-window -v -c "#{pane_current_path}"

# \ 垂直分割且寬度為 25%
bind \\ split-window -h -l 25% -c "#{pane_current_path}"
# - 水平分割且高度為 25%
bind - split-window -v -l 25% -c "#{pane_current_path}"

# ---------------------------------
# 彈出式終端機（Mars.nvim 風格）
# ---------------------------------
# <prefix> + t: 開啟彈出式終端
bind t display-popup -E -w 90% -h 90% -d "#{pane_current_path}"

# ---------------------------------
# 視窗管理
# ---------------------------------
# 快速切換到上一個視窗
bind Space last-window

# 創建新視窗時保持當前路徑
bind c new-window -c "#{pane_current_path}"

# ---------------------------------
# 窗格調整大小
# ---------------------------------
# 使用 Alt + 方向鍵調整窗格大小（不需要 prefix）
bind -n M-Left resize-pane -L 5
bind -n M-Right resize-pane -R 5
bind -n M-Up resize-pane -U 5
bind -n M-Down resize-pane -D 5

# 使用 prefix + H/J/K/L 調整窗格大小（大幅度）
bind H resize-pane -L 10
bind J resize-pane -D 10
bind K resize-pane -U 10
bind L resize-pane -R 10

# ---------------------------------
# 複製模式（Vi 風格）
# ---------------------------------
# 使用 Vi 模式
setw -g mode-keys vi

# v 開始選擇，y 複製（類似 Vim）
bind -T copy-mode-vi v send-keys -X begin-selection
bind -T copy-mode-vi y send-keys -X copy-selection-and-cancel
bind -T copy-mode-vi C-v send-keys -X rectangle-toggle

# macOS 系統剪貼簿整合
if-shell "uname | grep -q Darwin" \
    "bind -T copy-mode-vi y send-keys -X copy-pipe-and-cancel 'pbcopy'"

# Linux 系統剪貼簿整合（需要 xclip）
if-shell "uname | grep -q Linux" \
    "bind -T copy-mode-vi y send-keys -X copy-pipe-and-cancel 'xclip -in -selection clipboard'"

# ---------------------------------
# 狀態列簡化設定（可選）
# ---------------------------------
# 如果你想要更簡潔的狀態列，取消以下註解：

# # 狀態列刷新間隔
# set -g status-interval 5
#
# # 狀態列位置
# set -g status-position bottom
#
# # 狀態列顏色
# set -g status-style 'bg=#1e1e2e,fg=#cdd6f4'
#
# # 左側狀態列
# set -g status-left '#[fg=#89b4fa,bold] #S '
# set -g status-left-length 20
#
# # 右側狀態列
# set -g status-right '#[fg=#cdd6f4] %Y-%m-%d %H:%M '
# set -g status-right-length 50
#
# # 視窗狀態格式
# setw -g window-status-format ' #I:#W '
# setw -g window-status-current-format '#[fg=#1e1e2e,bg=#89b4fa,bold] #I:#W '

# ---------------------------------
# 重新載入配置
# ---------------------------------
# <prefix> + r: 重新載入 tmux 配置
bind r source-file ~/.tmux.conf \; display "配置已重新載入！"

# ---------------------------------
# 快速鍵提示
# ---------------------------------
# <prefix> + ?: 顯示所有快捷鍵
