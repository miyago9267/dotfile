#!/usr/bin/env python3
"""Project initialization tool"""

import os
import sys
import subprocess
import argparse
from pathlib import Path

class InitDevTool:
    """Tool for initializing development projects"""
    
    TEMPLATES = {
        'python': {
            'dirs': ['src', 'tests'],
            'files': {
                'README.md': '# {name}\n\nProject description\n',
                'src/__init__.py': '',
                '.gitignore': '*.pyc\n__pycache__/\n.env\n*.egg-info/\ndist/\nbuild/\n.venv/\n'
            }
        },
        'node': {
            'dirs': ['src'],
            'files': {
                'README.md': '# {name}\n\nProject description\n',
                '.gitignore': 'node_modules/\n.env\ndist/\nbuild/\n*.log\n'
            }
        },
        'go': {
            'dirs': ['cmd', 'pkg', 'internal'],
            'files': {
                'README.md': '# {name}\n\nProject description\n',
                '.gitignore': '*.exe\n*.test\n.env\n'
            }
        }
    }
    
    def __init__(self, project_name, project_type, with_git=True):
        self.project_name = project_name
        self.project_type = project_type
        self.with_git = with_git
        self.project_path = Path(project_name)
    
    def create_structure(self):
        """Create project directory structure"""
        if self.project_path.exists():
            print(f"‚ùå Directory '{self.project_name}' already exists!")
            return False
        
        print(f"üìÅ Creating project: {self.project_name}")
        self.project_path.mkdir(parents=True)
        os.chdir(self.project_path)
        
        template = self.TEMPLATES.get(self.project_type)
        if not template:
            print(f"‚ùå Unknown project type: {self.project_type}")
            return False
        
        # Create directories
        for dir_name in template['dirs']:
            Path(dir_name).mkdir(parents=True, exist_ok=True)
            print(f"  ‚úì Created {dir_name}/")
        
        # Create files
        for file_name, content in template['files'].items():
            Path(file_name).parent.mkdir(parents=True, exist_ok=True)
            Path(file_name).write_text(content.format(name=self.project_name))
            print(f"  ‚úì Created {file_name}")
        
        return True
    
    def init_tools(self):
        """Initialize project-specific tools"""
        print(f"\nüîß Initializing {self.project_type} project...")
        
        if self.project_type == 'python':
            if subprocess.run(['poetry', '--version'], capture_output=True).returncode == 0:
                subprocess.run(['poetry', 'init', '-n'])
                print("  ‚úì Initialized Poetry")
            else:
                print("  ‚ö† Poetry not found, skipping")
        
        elif self.project_type == 'node':
            subprocess.run(['npm', 'init', '-y'], capture_output=True)
            print("  ‚úì Initialized npm")
        
        elif self.project_type == 'go':
            subprocess.run(['go', 'mod', 'init', self.project_name])
            print("  ‚úì Initialized Go module")
    
    def init_git(self):
        """Initialize git repository"""
        if not self.with_git:
            return
        
        print("\nüîß Initializing git...")
        subprocess.run(['git', 'init'], capture_output=True)
        subprocess.run(['git', 'add', '.'], capture_output=True)
        subprocess.run(['git', 'commit', '-m', 'Initial commit'], capture_output=True)
        print("  ‚úì Git initialized")
    
    def run(self):
        """Run the initialization process"""
        if not self.create_structure():
            return False
        
        self.init_tools()
        self.init_git()
        
        print(f"\n‚úÖ Project '{self.project_name}' initialized successfully!")
        print(f"\nNext steps:")
        print(f"  cd {self.project_name}")
        return True

def main():
    parser = argparse.ArgumentParser(description='Initialize development project')
    parser.add_argument('name', help='Project name')
    parser.add_argument('type', choices=['python', 'node', 'go'], help='Project type')
    parser.add_argument('--no-git', action='store_true', help='Skip git initialization')
    
    args = parser.parse_args()
    
    tool = InitDevTool(args.name, args.type, with_git=not args.no_git)
    success = tool.run()
    
    sys.exit(0 if success else 1)

if __name__ == '__main__':
    main()